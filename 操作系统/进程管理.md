# 1. 进程,线程,协程

>  进程：进程是资源分配的基本单位。进程控制块 (Process Control Block, PCB) 描述进程的基本信息和运行状态，所谓的创建进程和撤销进程，都是指对 PCB 的操作。

操作系统对进程的感知是通过进程控制块来描述的，PCB是进程存在的唯一标识，包括以下信息：

1. 进程描述信息：进程标识符、用户标识符

2. 进程控制和管理信息：进程状态、进程优先级等

3. 进程资源分配清单：虚拟内存地址空间信息，打开文件列表，IO设备信息等

4. CPU相关信息：当进程切换时，CPU寄存器的值都被保存在相应PCB中，以便CPU重新执行该进程时能从断点处继续执行

> 线程(Thread)：线程是独立调度的基本单位。线程是操作系统能够进行运算调度的最小单位。一个进程中可以有多个线程，它们共享进程资源。

**区别：**

- 进程是资源分配的基本单位，但是线程不拥有资源，线程可以访问隶属进程的资源。
- 线程是独立调度的基本单位，在同一进程中，线程的切换不会引起进程切换，从一个进程中的线程切换到另一个进程中的线程时，会引起进程切换。
- 由于创建或撤销进程时，系统都要为之分配或回收资源，如内存空间、I/O 设备等，所付出的开销远大于创建或撤销线程时的开销。在进行进程切换时，涉及当前执行进程 CPU 环境的保存及新调度进程 CPU 环境的设置，而线程切换时只需保存和设置少量寄存器内容，开销很小。
- 线程间可以通过直接读写同一进程中的数据进行通信

> 协程：协程是一种比线程更加轻量级的存在，可以通过程序来管理，具有对内核来说不可见的特性。一个线程也可以拥有多个协程。

**区别**

- 线程的切换由操作系统负责调度，协程由用户自己进行调度，因此减少了上下文切换（线程的调度主体是操作系统，协程的调度主体是用户）
- 由于在同一个线程上，因此可以避免竞争关系而使用锁。

>  其他进程的概念

**僵尸进程**： 在父进程读取子进程状态前就结束了。

子进程比父进程先结束，而父进程又没有回收子进程，释放子进程占用的资源，此时==子进程将成为一个僵尸进程==。（子进程必须等到父进程捕获到了子进程的退出状态时才真正结束）。



**孤儿进程**：一个父进程退出，而它的一个或多个子进程还在运行，那么那些==子进程将成为孤儿进程==。

孤儿进程将被init进程(进程号为1)所收养，并由init进程对它们完成状态收集工作。

---

# 2. 线程状态

<img src="..\.image\image-20210805150324659.png" alt="image-20210805150324659" style="zoom:50%;" />

- 创建状态：正在创建进程中
- 就绪状态：除了处理器分配的时间片没有之外其他一切资源已经准备就绪
- 运行状态：进程正在处理器上运行
- 阻塞状态：等待状态。等待某一事件如等待某一个资源为可用或者等待IO操作完成
- 结束状态：进程正在系统中消失

阻塞态的进程**占用着物理内存**，在虚拟内存管理的操作系统中，通常会把阻塞态的进程的物理内存空间转换到硬盘上，等需要再次运行的时候，再从硬盘换到物理内存。

- 挂起态：新的状态，暂时挂到外存上等待的进程
- 阻塞挂起态：将进程转到外存上，等待某一事件的出现
- 就绪挂起态：将进程转到外存上，只要进入内存就马上开始

**特点：**

- 只有就绪态和运行态可以相互转换，其它的都是单向转换。就绪状态的进程通过调度算法从而获得 CPU 时间，转为运行状态；而运行状态的进程，在分配给它的 CPU 时间片用完之后就会转为就绪状态，等待下一次调度。
- 阻塞状态是缺少需要的资源从而由运行状态转换而来，但是该资源不包括 CPU 时间，缺少 CPU 时间会从运行态转换为就绪态(系统中断)。

  

---

# 3. 进程调度算法

>  **批处理系统**：用户操作少，目标是保证吞吐量

- 先来先服务（FCFS):按照请求的顺序进行调度
- 短作业优先(SJF):按估计运行时间最短的顺序进行调度，这里所谓的短作业是估计的运行时间最短的作业）
- 最短剩余时间优先（SNRT)：按剩余运行时间的顺序进行调度。当一个新的作业来了之后，其整个运行时间会和当前进程的剩余时间作比较，如果新的作业需要时间较少，则挂起当前进程运行新的线程。

> **交互式系统**：有大量的用户交互操作，目标是快速反应

1. 时间片轮转：因为进程切换都要保存进程的信息并且载入新进程的信息，如果时间片太小，会导致进程切换得太频繁，在进程切换上就会花过多时间。而如果时间片过长，那么实时性就不能得到保证。（首先将进程按FCFS排成一个队列，每次调度时，把CPU时间分配给队首进程，该进程执行一个时间片。当时间片用完后，由计时器发出时钟中断，调度程序便停止该进程的执行，将进程当道队尾，吧CPU时间片分配给队首进程）

2. 优先级调度：按进程的优先级进行调度

3. 多级反馈队列：一个进程需要执行 100 个时间片，如果采用时间片轮转调度算法，那么需要交换 100 次。（没看懂下边）多级队列是为这种需要连续执行多个时间片的进程考虑，**它设置了多个队列，每个队列时间片大小都不同**，例如 1,2,4,8,..。进程在第一个队列没执行完，就会被移到下一个队列。这种方式下，之前的进程只需要交换 7 次。

   **每个队列优先权也不同，最上面的优先权最高**。因此只有上一个队列没有进程在排队，才能调度当前队列上的进程。
   
   



---





# 4. 进程同步

进程之间的相互制约关系可以分为两种情况。

1. 间接制约关系：由于==竞争系统资源==而引起的。又称之为==互斥==。
2. 直接制约关系：由于==进程之间存在共享数据==而引起的。==又称之为同步==。

> **进程同步**是指控制多个进程按一定顺序执行；强调进程之间操作的先后次序。

对于同步机制，需要遵循以下四个规则：

- 空闲则入：没有进程在临界区时，任何进程可以进入；
- 忙则等待：有进程在临界区时，其他进程均不能进入临界区；
- 有限等待：等待进入临界区的进程不能无限期等待；
- 让权等待（可选）：不能进入临界区的进程，应该释放 `CPU`，如转换到阻塞态；

<font size='5pt'>进程同步的方式</font>

进程同步的解决方案主要有：信号量和管程。

> 互斥量

允许同一时刻只有一个线程访问共享资源。采用互斥对象机制，拥有互斥对象的线程才能访问共享资源。因为互斥对象只有一个，保证公共资源不会被多个线程同时访问。

> 信号量

用于进程间传递信号的一个整数值。在信号量上只有三种操作可以进行：初始化，P操作和V操作，这三种操作都是原子操作。

**P操作(递减操作)可以用于阻塞一个进程，V操作(增加操作)可以用于解除阻塞一个进程。**

> 管程

管程将**共享资源和对共享资源的操作（对资源的获取和释放）封装到一起来实现互斥性**，条件变量和对应的等待队列实现进程间的同步性。管程是由一个或多个过程、一个初始化序列和局部数据组成的软件模块，其主要特点如下：

- **局部数据变量只能被管程的过程访问，任何外部过程都不能访问。**
- **一个进程通过调用管程的一个过程进入管程。**
- **在任何时候，只能有一个进程在管程中执行，调用管程的任何其他进程都被阻塞，以等待管程可用。**

管程通过使用条件变量提供对同步的支持，这些条件变量包含在管程中，并且只有在管程中才能被访问。

有两个函数可以操作条件变量：

- `cwait(c)`：调用进程的执行在条件c上阻塞，管程现在可被另一个进程使用。
- `csignal(c)`：恢复执行在cwait之后因为某些条件而阻塞的进程。如果有多个这样的进程，选择其中一个；如果没有这样的进程，什么以不做。

> 消息传递

消息传递的实际功能以一对原语的形式提供：

- `send(destination,message)`
- `receive(source,message)`

这是进程间进程消息传递所需要的最小操作集。

一个进程以消息的形式给另一个指定的目标进程发送消息；

进程通过执行`receive`原语接收消息，`receive`原语中指明发送消息的源进程和消息。

<font size='6pt'>线程同步方式</font>



---





# 5. 进程通信

进程同步与进程通信很容易混淆，它们的区别在于：

- 进程同步：控制多个进程按一定顺序执行；
- 进程通信：进程间传输信息。

>  进程通信的方式

1. **匿名管道**：这是父子进程间或者兄弟进程之间的通信方式

2. **命名管道**: 由于匿名管道没有名字，只能用于具有亲缘关系的进程间通行，为了克服这一点，提出了有名管道。可以在不相关的进程间也能相互通信，以磁盘文件的方式存在。提供了一个路径名与之关联，==以FIFO文件形式存储在文件系统中==

   :exclamation:匿名管道：只存在于内存中的文件；命名管道：存在于磁盘介质或者文件系统中。消息队列和管道的通信数据都是先进先出的原则。

3. **消息队列**: 消息队列<font color='red'>不适合比较大数据的传输</font>，消息队列是保存在内核中的消息**链表**。

   与管道不同的是：消息队列只在内核（操作系统）重启时或者显示地删除一个消息队列时，该消息队列才会被真正的消除。

   消息队列**克服了信号承载信号量少，管道只能承载无格式字节流以及缓冲区大小受限**等缺点。

4. **信号量**：是一个整型的计数器，主要用于实现进程间的互斥与同步，而不是用于缓存进程间通信的数据。

5. **共享内存**：允许多个进程共享一块内存空间，不同进程可以及时查看到其他线程对共享内存中数据的更新。这种方式需要依靠某种同步操作，如信号量或者互斥锁等。

6. **套接字**：用于不同机器间的进程通信，客户端和服务器端之间通过网络进行通信。